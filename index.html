<script>
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

/* CONFIGURAÇÕES */
const candleWidth = 7;
const gap = 6;
const speed = 0.35; // velocidade do gráfico
const maxCandles = Math.ceil(canvas.width / (candleWidth + gap)) + 5;

let candles = [];
let basePrice = canvas.height * 0.6;

/* CRIA VELA */
function generateCandle(x) {
  const open = basePrice;
  const direction = Math.random() > 0.48 ? -1 : 1;
  const body = Math.random() * 28 + 8;
  const close = open + body * direction;
  const high = Math.min(open, close) - Math.random() * 16;
  const low = Math.max(open, close) + Math.random() * 16;

  basePrice = close;

  return { x, open, close, high, low };
}

/* INICIALIZA */
function initCandles() {
  candles = [];
  let x = 0;
  for (let i = 0; i < maxCandles; i++) {
    candles.push(generateCandle(x));
    x += candleWidth + gap;
  }
}
initCandles();

/* GRID */
function drawGrid() {
  ctx.strokeStyle = "#111";
  ctx.lineWidth = 1;

  for (let x = 0; x < canvas.width; x += 80) {
    ctx.beginPath();
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
    ctx.stroke();
  }

  for (let y = 0; y < canvas.height; y += 80) {
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
}

/* LOOP */
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawGrid();

  candles.forEach(c => {
    c.x -= speed;

    const color = c.close < c.open ? "#b5b5b5" : "#e0e0e0";

    // pavio
    ctx.strokeStyle = color;
    ctx.beginPath();
    ctx.moveTo(c.x + candleWidth / 2, c.high);
    ctx.lineTo(c.x + candleWidth / 2, c.low);
    ctx.stroke();

    // corpo
    ctx.fillStyle = color;
    ctx.fillRect(
      c.x,
      Math.min(c.open, c.close),
      candleWidth,
      Math.abs(c.close - c.open) || 1
    );
  });

  // recicla velas
  if (candles[0].x + candleWidth < 0) {
    candles.shift();
    const lastX = candles[candles.length - 1].x;
    candles.push(generateCandle(lastX + candleWidth + gap));
  }

  requestAnimationFrame(animate);
}

animate();
</script>
